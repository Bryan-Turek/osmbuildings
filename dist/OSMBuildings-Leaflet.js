(function($){function T(b,a){var c=b.x-a.x,d=b.y-a.y;return c*c+d*d}function fa(b,a){var c={};b/=U;a/=U;var d=wa,e;e=0>=a?90:1<=a?-90:(2*xa(ya(E*(1-2*a)))-K)/E*180;c[d]=e;c[za]=360*(1===b?1:(b%1+1)%1)-180;return c}function V(b){var a={minX:q,maxX:q+B,minY:n,maxY:n+z};return F(b.minX,b.minY,a)||F(b.maxX,b.minY,a)||F(b.maxX,b.maxY,a)||F(b.minX,b.maxY,a)}function F(b,a,c){return b>c.minX&&b<c.maxX&&a>c.minY&&a<c.maxY}function Aa(){M||(M=setInterval(function(){for(var b=C.items,a=!1,c=0,d=b.length;c<
d;c++)1>b[c].scale&&(b[c].scale+=0.1,1<b[c].scale&&(b[c].scale=1),a=!0);y.render();a||(clearInterval(M),M=null)},33))}function ga(b){N=aa+b.x;O=z+b.y;y.render(!0)}function ka(b){B=b.width;z=b.height;aa=B/2<<0;la=z/2<<0;N=aa;O=z;y.setSize(B,z);ma=t-50}function na(b){p=b;U=Ba<<p;ba=6/oa(2,p-G);D=oa(0.95,p-G);ha=""+H.alpha(D);ca=""+da.alpha(D);W=""+P.alpha(D)}var w=Math,ya=w.exp,Ca=w.log,Da=w.sin,Ea=w.cos,pa=w.tan,xa=w.atan,Q=w.atan2,ea=w.min,X=w.max,qa=w.sqrt,ra=w.ceil,oa=w.pow,ia=document,sa=sa||Array,
w=/iP(ad|hone|od)/g.test(navigator.userAgent),s=!!~navigator.userAgent.indexOf("Trident"),Fa=!$.requestAnimationFrame||w||s?function(b){b()}:$.requestAnimationFrame,J=function(b){function a(a,b,g){0>g&&(g+=1);1<g&&(g-=1);return g<1/6?a+6*(b-a)*g:0.5>g?b:g<2/3?a+(b-a)*(2/3-g)*6:a}var c={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",
silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},d=function(a,b,g,c){this.H=a;this.S=b;this.L=g;this.A=c};d.parse=function(a){var b=0,g=0,d=0,l=1,h;a=(""+a).toLowerCase();a=c[a]||a;if(h=a.match(/^#(\w{2})(\w{2})(\w{2})$/))b=parseInt(h[1],16),g=parseInt(h[2],16),d=parseInt(h[3],16);else if(h=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))b=parseInt(h[1],10),g=parseInt(h[2],10),d=parseInt(h[3],10),l=h[4]?parseFloat(h[5]):1;else return;return this.fromRGBA(b,g,d,l)};d.fromRGBA=
function(a,b,g,c){"object"===typeof a?(b=a.g/255,g=a.b/255,c=a.a,a=a.r/255):(a/=255,b/=255,g/=255);var l=Math.max(a,b,g),h=Math.min(a,b,g),m,I=(l+h)/2,r=l-h;if(r){h=0.5<I?r/(2-l-h):r/(l+h);switch(l){case a:m=(b-g)/r+(b<g?6:0);break;case b:m=(g-a)/r+2;break;case g:m=(a-b)/r+4}m*=60}else m=h=0;return new d(m,h,I,c)};d.prototype={toRGBA:function(){var b=Math.min(360,Math.max(0,this.H)),c=Math.min(1,Math.max(0,this.S)),g=Math.min(1,Math.max(0,this.L)),d=Math.min(1,Math.max(0,this.A)),l;if(0===c)b=l=c=
g;else{var h=0.5>g?g*(1+c):g+c-g*c,g=2*g-h,b=b/360,c=a(g,h,b+1/3);l=a(g,h,b);b=a(g,h,b-1/3)}return{r:Math.round(255*c),g:Math.round(255*l),b:Math.round(255*b),a:d}},toString:function(){var a=this.toRGBA();return 1===a.a?"#"+(16777216+(a.r<<16)+(a.g<<8)+a.b).toString(16).slice(1,7):"rgba("+[a.r,a.g,a.b,a.a.toFixed(2)].join()+")"},hue:function(a){return new d(this.H*a,this.S,this.L,this.A)},saturation:function(a){return new d(this.H,this.S*a,this.L,this.A)},lightness:function(a){return new d(this.H,
this.S,this.L*a,this.A)},alpha:function(a){return new d(this.H,this.S,this.L,this.A*a)}};return d}(this),Ga=function(){var b=Math,a=b.PI,c=b.sin,d=b.cos,e=b.tan,f=b.asin,g=b.atan2,k=a/180,l=23.4397*k;return function(b,m,I){I=k*-I;m*=k;b=b.valueOf()/864E5-0.5+2440588-2451545;var r=k*(357.5291+0.98560028*b),q;q=k*(1.9148*c(r)+0.02*c(2*r)+3E-4*c(3*r));q=r+q+102.9372*k+a;r=f(c(0)*d(l)+d(0)*c(l)*c(q));q=g(c(q)*d(l)-e(0)*c(l),d(q));b=k*(280.16+360.9856235*b)-I-q;I=f(c(m)*c(r)+d(m)*d(r)*d(b));m=g(c(b),d(b)*
c(m)-e(r)*d(m));return{altitude:I,azimuth:m-a/2}}}(),ua=function(){function b(a){a=a.toLowerCase();return"#"===a[0]?a:e[f[a]||a]||null}function a(b){var d,l,h=[],e;switch(b.type){case "GeometryCollection":h=[];d=0;for(l=b.geometries.length;d<l;d++)(e=a(b.geometries[d]))&&h.push.apply(h,e);return h;case "MultiPolygon":h=[];d=0;for(l=b.coordinates.length;d<l;d++)(e=a({type:"Polygon",coordinates:b.coordinates[d]}))&&h.push.apply(h,e);return h;case "Polygon":b=b.coordinates;break;default:return[]}if(h=
c(b[0])){e=[];d=1;for(l=b.length;d<l;d++)e[d]=c(b[d]);return[{outer:h,inner:e.length?e:null}]}}function c(a){for(var b,c,d=new sa(a.length),e=0,f=a.length;e<f;e++)b=a[e][0],c=ea(1,X(0,0.5-Ca(pa(Ha+K*a[e][1]/180))/E/2)),b=(b/360+0.5)*U<<0,c=c*U<<0,d.push(b,c);if(!(8>d.length))return d}function d(a,b){var c=a.length;if(16>c)return!1;var d;d=b.maxX-b.minX;var e=b.maxY-b.minY,f=d/e;if(0.85>f||1.15<f)return!1;f={x:b.minX+d/2,y:b.minY+e/2};d=(d+e)/4;e=d*d;for(d=0;d<c-1;d+=2){var r=T({x:a[d],y:a[d+1]},f);
if(0.8>r/e||1.2<r/e)return!1}return!0}var e={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},f={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",
paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};return{"import":function(c){if(!c||"FeatureCollection"!==c.type)return[];c=c.features;var e,l,h,f,q=[],r,n,t,u,p;e=0;for(l=c.length;e<l;e++)if(r=c[e],"Feature"===r.type&&!1!==ta(r)){h=(h=r.properties)||{};f={};
n=h.minHeight||(h.minLevel?3*h.minLevel:0);f.height=ea((h.height||(h.levels?3*h.levels:Ia))/ba,ma);f.minHeight=n/ba;n=void 0;(t=h.material?b(h.material):h.wallColor||h.color)&&(n=J.parse(t))&&(n=n.alpha(D),f.altColor=""+n.lightness(0.8),f.wallColor=""+n);(t=h.roofMaterial?b(h.roofMaterial):h.roofColor)&&(n=J.parse(t))&&(f.roofColor=""+n.alpha(D));switch(h.shape){case "cylinder":case "cone":case "dome":case "sphere":f.shape=h.shape;f.isRotational=!0;break;case "pyramid":f.shape=h.shape}switch(h.roofShape){case "cone":case "dome":f.roofShape=
h.roofShape;f.isRotational=!0;break;case "pyramid":f.roofShape=h.roofShape}f.roofShape&&h.roofHeight?(f.roofHeight=h.roofHeight/ba,f.height=X(0,f.height-f.roofHeight)):f.roofHeight=0;t=f.minHeight>f.height?void 0:f;if(n=a(r.geometry))for(h=0,f=n.length;h<f;h++){u=t;p={};var s=void 0;for(s in u)u.hasOwnProperty(s)&&(p[s]=u[s]);u=p;u.footprint=n[h].outer;p=u;for(var s=u.footprint,v=Infinity,x=-Infinity,w=Infinity,z=-Infinity,y=0,A=s.length-3;y<A;y+=2)v=ea(v,s[y]),x=X(x,s[y]),w=ea(w,s[y+1]),z=X(z,s[y+
1]);p.bbox=p={x:v+(x-v)/2<<0,y:w+(z-w)/2<<0};u.center={x:p.minX+(p.maxX-p.minX)/2<<0,y:p.minY+(p.maxY-p.minY)/2<<0};!u.shape&&d(u.footprint,u.bbox)&&(u.isRotational=!0,u.shape="cylinder");u.isRotational&&(u.radius=(p.maxX-p.minX)/2);n[h].inner&&(u.holes=n[h].inner);u.id=r.id||r.properties.id||[u.footprint[0],u.footprint[1],u.height,u.minHeight].join();r.properties.relationId&&(u.relationId=r.properties.relationId);u.hitColor=Y.idToColor(u.relationId||u.id);q.push(u)}}return q}}}(),E=Math.PI,K=E/2,
Ha=E/4,Ba=256,p,U,G=15,wa="latitude",za="longitude",B=0,z=0,aa=0,la=0,q=0,n=0,H=J.parse("rgba(200, 190, 180)"),da=H.lightness(0.8),P=H.lightness(1.2),ha=""+H,ca=""+da,W=""+P,D=1,ba=1,ma,Ia=5,N,O,t=450,R,Ja=function(b){function a(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4===c.readyState&&c.status&&!(200>c.status||299<c.status)&&b&&c.responseText){var a;try{a=JSON.parse(c.responseText)}catch(d){}b(a)}};c.open("GET",a);c.send(null);return c}function c(a,b){return a.replace(/\{(\w+)\}/g,
function(a,c){return b[c]||a})}function d(a,b){return a[0]>b.minX&&a[0]<b.maxX&&a[1]>b.minY&&a[1]<b.maxY}function e(a,b){var c,e;switch(a.type){case "Point":return d(a.coordinates,b);case "MultiPoint":case "LineString":for(c=0;c<a.coordinates.length;c++)if(d(a.coordinates[c],b))return!0;return!1;case "MultiLineString":for(c=0;c<a.coordinates.length;c++)for(e=0;e<a.coordinates[c].length;e++)if(d(a.coordinates[c][e],b))return!0;return!1;case "Polygon":for(c=0;c<a.coordinates[0].length;c++)if(d(a.coordinates[0][c],
b))return!0;return!1;case "MultiPolygon":for(c=0;c<a.coordinates.length;c++)for(e=0;e<a.coordinates[c][0].length;e++)if(d(a.coordinates[c][0][e],b))return!0;return!1}}function f(a){a=a||{};this.tileSize=a.tileSize||256;this.minZoom=void 0!==a.minZoom?a.minZoom:14;this.maxZoom=a.maxZoom||Infinity;this._scaleThreshold=a.scaleThreshold||16;var b="/0.2/"+(a.key||"anonymous");this._tileURL=a.tileURL||"http://{s}.data.osmbuildings.org"+b+"/tile/{z}/{x}/{y}.json";this._featureURL=a.featureURL||"http://data.osmbuildings.org"+
b+"/feature/{id}.json";this._bboxURL=a.bboxURL||"http://data.osmbuildings.org"+b+"/bbox.json?bbox={n},{e},{s},{w}";this._isLoading={}}f.ATTRIBUTION='Data Service &copy; <a href="http://bld.gs">BLDGS</a>';f.prototype={loadTile:function(a,b,d,f){var m;if(d<this.minZoom||d>this.maxZoom)return!1;if(d<=this._scaleThreshold)return m="abcd"[(a+b)%4],a=c(this._tileURL,{s:m,x:a,y:b,z:d}),this._load(a,f);m=Math.pow(2,d-this._scaleThreshold);a/=m;d=this._scaleThreshold;m="abcd"[(a+b/m)%4];a=c(this._tileURL,
{s:m,x:a,y:a,z:d});return this._load(a,function(a,b,c,d){var g=fa(a,b),k=fa(a+this.tileSize,b+this.tileSize),l={minX:g.longitude,maxX:k.longitude,minY:g.latitude,maxY:k.latitude};d.features&&(d.features=d.features.filter(function(a){return e(a.geometry,l)}));d.geometries&&(d.geometries=d.geometries.filter(function(a){return e(a,l)}));f(a,b,c,d)})},loadFeature:function(a,b){var d=c(this._featureURL,{id:a});return this._load(d,b)},loadBBox:function(a,b,d,e,f){a=c(this._bboxURL,{n:a.toFixed(5),e:b.toFixed(5),
s:d.toFixed(5),w:e.toFixed(5)});return this._load(a,f)},abortAll:function(){for(var a in this._isLoading)this._isLoading.hasOwnProperty(a)&&this._isLoading[a].abort()},destroy:function(){this.abortAll()},_load:function(b,c){if(!this._isLoading[b]){var d=this;this._isLoading[b]=a(b,function(a){delete d._isLoading[b];c(a)});return this._isLoading[b]}}};return f}(this),C={tiles:{},duplicates:{},items:[],init:function(b){this.provider=b||new Ja({key:"anonymous"});this.update()},update:function(){this.items=
[];this.duplicates={};Y.reset();this.provider.abortAll();if(!(p<G)){var b=this.provider.tileSize,a=q/b<<0,c=n/b<<0,d=ra((q+B)/b),b=ra((n+z)/b),e,f,g=this,k=function(){g.processTiles()},l=function(a){return function(a,b){g.tiles[p]||(g.tiles[p]={});g.tiles[p][a]=ua["import"](b);g.processTiles()}};this.provider.getTile(e,f,p,function(a){return function(b){g.tiles[p]||(g.tiles[p]={});g.tiles[p][a]=ua["import"](b);g.processTiles()}}([e,f].join()));for(f=c;f<=b;f++)for(e=a;e<=d;e++)c=[e,f].join(),this.tiles[p]&&
this.tiles[p][c]?setTimeout(k,1):this.provider.getTile(e,f,p,l);this.dropInvisibleTiles()}},processTiles:function(){var b=this.tiles[p],a,c;for(c in b)if(b.hasOwnProperty(c)){a=b[c];for(var d=0,e=a.length;d<e;d++)this.duplicates[a[d].id]||(this.items.push(a[d]),this.duplicates[a[d].id]=1)}Aa()},dropInvisibleTiles:function(){for(var b in this.tiles)b!==p&&(this.tiles[b]=[]);b=this.provider.tileSize;var a={minX:q,maxX:q+B,minY:n,maxY:n+z},c=this.tiles[p],d,e,f;for(f in c)c.hasOwnProperty(f)&&(d=f.split(","),
e=d.x*b,d=d.y*b,F(e,d,a)||F(e+b,d,a)||F(e,d+b,a)||F(e+b,d+b,a)||(c[f]=null))}},Z={draw:function(b,a,c,d,e,f,g,k){var l,h=this._extrude(b,a,d,e,f,g),m=[];if(c)for(a=0,l=c.length;a<l;a++)m[a]=this._extrude(b,c[a],d,e,f,g);b.fillStyle=k;b.beginPath();this._ring(b,h);if(c)for(a=0,l=m.length;a<l;a++)this._ring(b,m[a]);b.closePath();b.stroke();b.fill()},_extrude:function(b,a,c,d,e,f){c=t/(t-c);for(var g=t/(t-d),k={x:0,y:0},l={x:0,y:0},h,m,p=[],r=0,s=a.length-3;r<s;r+=2)k.x=a[r]-q,k.y=a[r+1]-n,l.x=a[r+2]-
q,l.y=a[r+3]-n,h=v.project(k,c),m=v.project(l,c),d&&(k=v.project(k,g),l=v.project(l,g)),(l.x-k.x)*(h.y-k.y)>(h.x-k.x)*(l.y-k.y)&&(b.fillStyle=k.x<l.x&&k.y<l.y||k.x>l.x&&k.y>l.y?f:e,b.beginPath(),this._ring(b,[l.x,l.y,k.x,k.y,h.x,h.y,m.x,m.y]),b.closePath(),b.fill()),p[r]=h.x,p[r+1]=h.y;return p},_ring:function(b,a){b.moveTo(a[0],a[1]);for(var c=2,d=a.length-1;c<d;c+=2)b.lineTo(a[c],a[c+1])},simplified:function(b,a,c){b.beginPath();this._ringAbs(b,a);if(c){a=0;for(var d=c.length;a<d;a++)this._ringAbs(b,
c[a])}b.closePath();b.stroke();b.fill()},_ringAbs:function(b,a){b.moveTo(a[0]-q,a[1]-n);for(var c=2,d=a.length-1;c<d;c+=2)b.lineTo(a[c]-q,a[c+1]-n)},shadow:function(b,a,c,d,e){for(var f=null,g={x:0,y:0},k={x:0,y:0},l,h,m=0,p=a.length-3;m<p;m+=2)g.x=a[m]-q,g.y=a[m+1]-n,k.x=a[m+2]-q,k.y=a[m+3]-n,l=A.project(g,d),h=A.project(k,d),e&&(g=A.project(g,e),k=A.project(k,e)),(k.x-g.x)*(l.y-g.y)>(l.x-g.x)*(k.y-g.y)?(1===f&&b.lineTo(g.x,g.y),f=0,m||b.moveTo(g.x,g.y),b.lineTo(k.x,k.y)):(0===f&&b.lineTo(l.x,l.y),
f=1,m||b.moveTo(l.x,l.y),b.lineTo(h.x,h.y));if(c)for(m=0,p=c.length;m<p;m++)this._ringAbs(b,c[m])},shadowMask:function(b,a,c){this._ringAbs(b,a);if(c){a=0;for(var d=c.length;a<d;a++)this._ringAbs(b,c[a])}},hitArea:function(b,a,c,d,e,f){c=null;var g={x:0,y:0},k={x:0,y:0};d=t/(t-d);var l=t/(t-e),h;b.fillStyle=f;b.beginPath();for(var m=0,p=a.length-3;m<p;m+=2)g.x=a[m]-q,g.y=a[m+1]-n,k.x=a[m+2]-q,k.y=a[m+3]-n,f=v.project(g,d),h=v.project(k,d),e&&(g=v.project(g,l),k=v.project(k,l)),(k.x-g.x)*(f.y-g.y)>
(f.x-g.x)*(k.y-g.y)?(1===c&&b.lineTo(g.x,g.y),c=0,m||b.moveTo(g.x,g.y),b.lineTo(k.x,k.y)):(0===c&&b.lineTo(f.x,f.y),c=1,m||b.moveTo(f.x,f.y),b.lineTo(h.x,h.y));b.closePath();b.fill()}},x={draw:function(b,a,c,d,e,f,g,k,l){a={x:a.x-q,y:a.y-n};var h=t/(t-e),m=t/(t-f);e=v.project(a,h);d*=h;f&&(a=v.project(a,m),c*=m);(h=this._tangents(a,c,e,d))?(f=Q(h[0].y1-a.y,h[0].x1-a.x),h=Q(h[1].y1-a.y,h[1].x1-a.x)):(f=1.5*E,h=1.5*E);b.fillStyle=g;b.beginPath();b.arc(e.x,e.y,d,K,f,!0);b.arc(a.x,a.y,c,f,K);b.closePath();
b.fill();b.fillStyle=k;b.beginPath();b.arc(e.x,e.y,d,h,K,!0);b.arc(a.x,a.y,c,K,h);b.closePath();b.fill();b.fillStyle=l;this._circle(b,e,d)},simplified:function(b,a,c){this._circle(b,{x:a.x-q,y:a.y-n},c)},shadow:function(b,a,c,d,e,f){a={x:a.x-q,y:a.y-n};e=A.project(a,e);var g;f&&(a=A.project(a,f));var k=this._tangents(a,c,e,d);k?(f=Q(k[0].y1-a.y,k[0].x1-a.x),g=Q(k[1].y1-a.y,k[1].x1-a.x),b.moveTo(k[1].x2,k[1].y2),b.arc(e.x,e.y,d,g,f),b.arc(a.x,a.y,c,f,g)):(b.moveTo(a.x+c,a.y),b.arc(a.x,a.y,c,0,2*E))},
shadowMask:function(b,a,c){var d=a.x-q;a=a.y-n;b.moveTo(d+c,a);b.arc(d,a,c,0,2*E)},hitArea:function(b,a,c,d,e,f,g){a={x:a.x-q,y:a.y-n};var k=t/(t-e),l=t/(t-f);e=v.project(a,k);d*=k;f&&(a=v.project(a,l),c*=l);f=this._tangents(a,c,e,d);b.fillStyle=g;b.beginPath();f?(g=Q(f[0].y1-a.y,f[0].x1-a.x),k=Q(f[1].y1-a.y,f[1].x1-a.x),b.moveTo(f[1].x2,f[1].y2),b.arc(e.x,e.y,d,k,g),b.arc(a.x,a.y,c,g,k)):(b.moveTo(a.x+c,a.y),b.arc(a.x,a.y,c,0,2*E));b.closePath();b.fill()},_circle:function(b,a,c){b.beginPath();b.arc(a.x,
a.y,c,0,2*E);b.stroke();b.fill()},_tangents:function(b,a,c,d){var e=b.x-c.x,f=b.y-c.y,g=a-d,k=e*e+f*f;if(!(k<=g*g)){var k=qa(k),e=-e/k,f=-f/k,g=g/k,k=[],l,h,m;l=qa(X(0,1-g*g));for(var n=1;-1<=n;n-=2)h=e*g-n*l*f,m=f*g+n*l*e,k.push({x1:b.x+a*h<<0,y1:b.y+a*m<<0,x2:c.x+d*h<<0,y2:c.y+d*m<<0});return k}}},S={draw:function(b,a,c,d,e,f,g){var k=t/(t-e);c=v.project({x:c.x-q,y:c.y-n},t/(t-d));d={x:0,y:0};for(var l={x:0,y:0},h=0,m=a.length-3;h<m;h+=2)d.x=a[h]-q,d.y=a[h+1]-n,l.x=a[h+2]-q,l.y=a[h+3]-n,e&&(d=v.project(d,
k),l=v.project(l,k)),(l.x-d.x)*(c.y-d.y)>(c.x-d.x)*(l.y-d.y)&&(b.fillStyle=d.x<l.x&&d.y<l.y||d.x>l.x&&d.y>l.y?g:f,b.beginPath(),this._triangle(b,d,l,c),b.closePath(),b.fill())},_triangle:function(b,a,c,d){b.moveTo(a.x,a.y);b.lineTo(c.x,c.y);b.lineTo(d.x,d.y)},_ring:function(b,a){b.moveTo(a[0]-q,a[1]-n);for(var c=2,d=a.length-1;c<d;c+=2)b.lineTo(a[c]-q,a[c+1]-n)},shadow:function(b,a,c,d,e){var f={x:0,y:0},g={x:0,y:0};c=A.project({x:c.x-q,y:c.y-n},d);d=0;for(var k=a.length-3;d<k;d+=2)f.x=a[d]-q,f.y=
a[d+1]-n,g.x=a[d+2]-q,g.y=a[d+3]-n,e&&(f=A.project(f,e),g=A.project(g,e)),(g.x-f.x)*(c.y-f.y)>(c.x-f.x)*(g.y-f.y)&&this._triangle(b,f,g,c)},shadowMask:function(b,a){this._ring(b,a)},hitArea:function(b,a,c,d,e,f){var g=t/(t-e);c=v.project({x:c.x-q,y:c.y-n},t/(t-d));d={x:0,y:0};var k={x:0,y:0};b.fillStyle=f;b.beginPath();f=0;for(var l=a.length-3;f<l;f+=2)d.x=a[f]-q,d.y=a[f+1]-n,k.x=a[f+2]-q,k.y=a[f+3]-n,e&&(d=v.project(d,g),k=v.project(k,g)),(k.x-d.x)*(c.y-d.y)>(c.x-d.x)*(k.y-d.y)&&this._triangle(b,
d,k,c);b.closePath();b.fill()}},v={project:function(b,a){return{x:(b.x-N)*a+N<<0,y:(b.y-O)*a+O<<0}},render:function(){var b=this.context;b.clearRect(0,0,B,z);if(!(p<G||R)){var a,c,d,e={x:N+q,y:O+n},f,g,k,l,h=C.items;h.sort(function(a,b){return a.minHeight-b.minHeight||T(b.center,e)-T(a.center,e)||b.height-a.height});for(var m=0,s=h.length;m<s;m++)if(a=h[m],!ja.isSimple(a)&&(f=a.footprint,V(a.bbox))){c=1>a.scale?a.height*a.scale:a.height;d=0;a.minHeight&&(d=1>a.scale?a.minHeight*a.scale:a.minHeight);
g=a.wallColor||ha;k=a.altColor||ca;l=a.roofColor||W;b.strokeStyle=k;switch(a.shape){case "cylinder":x.draw(b,a.center,a.radius,a.radius,c,d,g,k,l);break;case "cone":x.draw(b,a.center,a.radius,0,c,d,g,k);break;case "dome":x.draw(b,a.center,a.radius,a.radius/2,c,d,g,k);break;case "sphere":x.draw(b,a.center,a.radius,a.radius,c,d,g,k,l);break;case "pyramid":S.draw(b,f,a.center,c,d,g,k);break;default:Z.draw(b,f,a.holes,c,d,g,k,l)}switch(a.roofShape){case "cone":x.draw(b,a.center,a.radius,0,c+a.roofHeight,
c,l,""+J.parse(l).lightness(0.9));break;case "dome":x.draw(b,a.center,a.radius,a.radius/2,c+a.roofHeight,c,l,""+J.parse(l).lightness(0.9));break;case "pyramid":S.draw(b,f,a.center,c+a.roofHeight,c,l,J.parse(l).lightness(0.9))}}}}},ja={maxZoom:G+2,maxHeight:5,isSimple:function(b){return p<=this.maxZoom&&b.height+b.roofHeight<this.maxHeight},render:function(){var b=this.context;b.clearRect(0,0,B,z);if(!(p<G||R||p>this.maxZoom))for(var a,c,d=C.items,e=0,f=d.length;e<f;e++)if(a=d[e],!(a.height>=this.maxHeight)&&
(c=a.footprint,V(a.bbox)))switch(b.strokeStyle=a.altColor||ca,b.fillStyle=a.roofColor||W,a.shape){case "cylinder":case "cone":case "dome":case "sphere":x.simplified(b,a.center,a.radius);break;default:Z.simplified(b,c,a.holes)}}},A={enabled:!0,color:"#666666",blurColor:"#000000",blurSize:15,date:new Date,direction:{x:0,y:0},project:function(b,a){return{x:b.x+this.direction.x*a,y:b.y+this.direction.y*a}},render:function(){var b=this.context,a,c,d;b.clearRect(0,0,B,z);if(!(!this.enabled||p<G||R||(a=
fa(aa+q,la+n),a=Ga(this.date,a.latitude,a.longitude),0>=a.altitude))){c=1/pa(a.altitude);d=5>c?0.75:1/c*5;this.direction.x=Ea(a.azimuth)*c;this.direction.y=Da(a.azimuth)*c;var e,f,g,k;a=C.items;b.canvas.style.opacity=d/(2*D);b.shadowColor=this.blurColor;b.shadowBlur=D/2*this.blurSize;b.fillStyle=this.color;b.beginPath();d=0;for(c=a.length;d<c;d++)if(e=a[d],k=e.footprint,V(e.bbox)){f=1>e.scale?e.height*e.scale:e.height;g=0;e.minHeight&&(g=1>e.scale?e.minHeight*e.scale:e.minHeight);switch(e.shape){case "cylinder":x.shadow(b,
e.center,e.radius,e.radius,f,g);break;case "cone":x.shadow(b,e.center,e.radius,0,f,g);break;case "dome":x.shadow(b,e.center,e.radius,e.radius/2,f,g);break;case "sphere":x.shadow(b,e.center,e.radius,e.radius,f,g);break;case "pyramid":S.shadow(b,k,e.center,f,g);break;default:Z.shadow(b,k,e.holes,f,g)}switch(e.roofShape){case "cone":x.shadow(b,e.center,e.radius,0,f+e.roofHeight,f);break;case "dome":x.shadow(b,e.center,e.radius,e.radius/2,f+e.roofHeight,f);break;case "pyramid":S.shadow(b,k,e.center,f+
e.roofHeight,f)}}b.closePath();b.fill();b.shadowBlur=null;b.globalCompositeOperation="destination-out";b.beginPath();d=0;for(c=a.length;d<c;d++)if(e=a[d],k=e.footprint,V(e.bbox)&&!e.minHeight)switch(e.shape){case "cylinder":case "cone":case "dome":x.shadowMask(b,e.center,e.radius);break;default:Z.shadowMask(b,k,e.holes)}b.fillStyle="#00ff00";b.fill();b.globalCompositeOperation="source-over"}}},Y={_idMapping:[null],reset:function(){this._idMapping=[null]},render:function(){if(!this._timer){var b=this;
this._timer=setTimeout(function(){b._timer=null;b._render()},500)}},_render:function(){var b=this.context;b.clearRect(0,0,B,z);if(!(p<G||R)){var a,c,d,e={x:N+q,y:O+n},f,g,k=C.items;k.sort(function(a,b){return a.minHeight-b.minHeight||T(b.center,e)-T(a.center,e)||b.height-a.height});for(var l=0,h=k.length;l<h;l++)if(a=k[l],g=a.hitColor)if(f=a.footprint,V(a.bbox)){c=a.height;d=0;a.minHeight&&(d=a.minHeight);switch(a.shape){case "cylinder":x.hitArea(b,a.center,a.radius,a.radius,c,d,g);break;case "cone":x.hitArea(b,
a.center,a.radius,0,c,d,g);break;case "dome":x.hitArea(b,a.center,a.radius,a.radius/2,c,d,g);break;case "sphere":x.hitArea(b,a.center,a.radius,a.radius,c,d,g);break;case "pyramid":S.hitArea(b,f,a.center,c,d,g);break;default:Z.hitArea(b,f,a.holes,c,d,g)}switch(a.roofShape){case "cone":x.hitArea(b,a.center,a.radius,0,c+a.roofHeight,c,g);break;case "dome":x.hitArea(b,a.center,a.radius,a.radius/2,c+a.roofHeight,c,g);break;case "pyramid":S.hitArea(b,f,a.center,c+a.roofHeight,c,g)}}this._imageData=this.context.getImageData(0,
0,B,z).data}},getIdFromXY:function(b,a){var c=this._imageData;if(c){var d=4*((a|0)*B+(b|0));return this._idMapping[c[d]|c[d+1]<<8|c[d+2]<<16]}},idToColor:function(b){var a=this._idMapping.indexOf(b);-1===a&&(this._idMapping.push(b),a=this._idMapping.length-1);return"rgb("+[a&255,a>>8&255,a>>16&255].join()+")"}},M,y={container:ia.createElement("DIV"),items:[],init:function(){this.container.style.pointerEvents="none";this.container.style.position="absolute";this.container.style.left=0;this.container.style.top=
0;A.context=this.createContext(this.container);ja.context=this.createContext(this.container);v.context=this.createContext(this.container);Y.context=this.createContext()},render:function(b){Fa(function(){b||(A.render(),ja.render(),Y.render());v.render()})},createContext:function(b){var a=ia.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin=
"round";c.lineWidth=1;c.mozImageSmoothingEnabled=!1;c.webkitImageSmoothingEnabled=!1;this.items.push(a);b&&b.appendChild(a);return c},appendTo:function(b){b.appendChild(this.container)},remove:function(){this.container.parentNode.removeChild(this.container)},setSize:function(b,a){for(var c=0,d=this.items.length;c<d;c++)this.items[c].width=b,this.items[c].height=a},screenshot:function(){var b=ia.createElement("CANVAS"),a=b.getContext("2d"),c,d,e;b.width=B;b.height=z;clearInterval(M);M=null;e=C.items;
c=0;for(d=e.length;c<d;c++)e[c].scale=1;this.render(!0);c=0;for(d=this.items.length;c<d;c++)e=this.items[c],""!==e.style.opacity&&(a.globalAlpha=parseFloat(e.style.opacity)),a.drawImage(e,0,0),a.globalAlpha=1;return b.toDataURL("image/png")},setPosition:function(b,a){this.container.style.left=b+"px";this.container.style.top=a+"px"}};y.init();w=function(b){this.offset={x:0,y:0};b.addLayer(this)};s=w.prototype=L.Layer?new L.Layer:{};s.onAdd=function(b){this.map=b;y.appendTo(b._panes.overlayPane);var a=
this.getOffset(),c=b.getPixelOrigin();ka({width:b._size.x,height:b._size.y});var d=c.y-a.y;q=c.x-a.x;n=d;na(b._zoom);y.setPosition(-a.x,-a.y);b.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this);if(b.options.zoomAnimation)b.on("zoomanim",this.onZoom,this);b.attributionControl&&b.attributionControl.addAttribution('&copy; <a href="http://osmbuildings.org">OSM Buildings</a>');C.update()};
s.onRemove=function(){var b=this.map;b.attributionControl&&b.attributionControl.removeAttribution('&copy; <a href="http://osmbuildings.org">OSM Buildings</a>');b.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this);b.options.zoomAnimation&&b.off("zoomanim",this.onZoom,this);y.remove()};s.onMove=function(b){b=this.getOffset();ga({x:this.offset.x-b.x,y:this.offset.y-b.y})};s.onMoveEnd=
function(b){if(this.noMoveEnd)this.noMoveEnd=!1;else{var a=this.map;b=this.getOffset();var c=a.getPixelOrigin();this.offset=b;y.setPosition(-b.x,-b.y);ga({x:0,y:0});ka({width:a._size.x,height:a._size.y});a=c.y-b.y;q=c.x-b.x;n=a;y.render();C.update()}};s.onZoomStart=function(b){R=!0;y.render()};s.onZoom=function(b){};s.onZoomEnd=function(b){b=this.map;var a=this.getOffset(),c=b.getPixelOrigin(),d=c.y-a.y;q=c.x-a.x;n=d;b=b._zoom;R=!1;na(b);C.update();y.render();this.noMoveEnd=!0};s.onResize=function(){};
s.onViewReset=function(){var b=this.getOffset();this.offset=b;y.setPosition(-b.x,-b.y);ga({x:0,y:0})};s.onClick=function(b){var a=Y.getIdFromXY(b.containerPoint.x,b.containerPoint.y);a&&va({feature:a,lat:b.latlng.lat,lon:b.latlng.lng})};s.getOffset=function(){return L.DomUtil.getPosition(this.map._mapPane)};s.style=function(b){b=b||{};var a;if(a=b.color||b.wallColor)H=J.parse(a),ha=""+H.alpha(D),da=H.lightness(0.8),ca=""+da.alpha(D),P=H.lightness(1.2),W=""+P.alpha(D);b.roofColor&&(P=J.parse(b.roofColor),
W=""+P.alpha(D));void 0!==b.shadows&&(A.enabled=!!b.shadows);y.render();return this};s.date=function(b){A.date=b;A.render();return this};s.load=function(b){C.load(b);return this};s.set=function(b){C.set(b);return this};s.screenshot=function(b){var a=y.screenshot();b&&($.location.href=a.replace("image/png","image/octet-stream"));return a};var ta=function(){};s.each=function(b){ta=function(a){return b(a)};return this};var va=function(){};s.click=function(b){va=function(a){return b(a)};return this};
s.getDetails=function(b,a){C.provider&&C.provider.getFeature(b,a);return this};w.VERSION="0.2.2b";w.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>';$.OSMBuildings=w})(this);
